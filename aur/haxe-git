# Maintainer: Tom Bebbington <tophattedcoder@gmail.com>
pkgname=haxe-git
pkgrel=1
pkgver=1cc670d
pkgdesc="A multiplatform open source programming language"
arch=('i686' 'x86_64')
url="https://github.com/HaxeFoundation/haxe"
license=('GPL2' 'MIT')
groups=('devel')
depends=('neko>=2.0.0')
makedepends=('git' 'ocaml' 'sed' 'zlib' 'neko>=2.0.0')
provides=('haxe')
conflicts=('haxe')
options=('!strip' 'emptydirs' '!makeflags')
install=haxe.install
source=('haxe.sh' "haxe::git+https://github.com/HaxeFoundation/haxe")
md5sums=('2744426baf31e3602473bcb8397947e3'
         'SKIP')
_gitmod=haxe

pkgver() {
	cd "$SRCDEST"/haxe
	git log --pretty=format:'%h' -n 1
}

build() {
	cd "$srcdir"
	
	msg "Git checkout done or server timeout"
	cd $srcdir/$_gitmod
	msg "Initialising submodules"
	git submodule init
	msg "Updating submodules"
	git submodule update
	msg "Starting build..."
	
	#
	# BUILD HERE
	#
	msg "Cleaning up..."
	make clean > /dev/null
	msg2 "done."
	
	msg "Git commit hash is ${pkgver}. Starting build..."
	sed --in-place=.orig -e "s/\\(Haxe Compiler %d\.%d\.%d\\) -/\\1 [Git commit $pkgver] -/" main.ml 
	msg "Building libs..." && make libs || return 1
	msg2 "done."
	msg "Building haxe..." && make haxe || return 1
	msg2 "done."
	_res=$?
	if [ $_res -eq 0 ]; then _msg="done."; else _msg="failed."; fi
	echo && msg2 $_msg
	return $_res
}

package() {
	cd $srcdir/$_gitmod
	mkdir -p $pkgdir/usr/bin
	mkdir -p $pkgdir/usr/lib
	env HAXE_STD_PATH=$srcdir/$_gitmod/std make INSTALL_DIR="$pkgdir/usr" install install_tools
	mkdir -p $pkgdir/etc/profile.d
	cp $srcdir/haxe.sh $pkgdir/etc/profile.d
	mkdir -p $pkgdir/usr/share/licenses/haxe-git
	cp $srcdir/$_gitmod/doc/LICENSE.txt $pkgdir/usr/share/licenses/haxe-git/LICENSE
}
