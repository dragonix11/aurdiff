# Author: Mathieu Boespflug <mboes@tweag.net> (original 0.9.21)
# Maintainer: Alexey Stukalov <astukalov@gmail.com> (updated to 2.x)
# Contributor: Nikolay Amiantov <nikoamia@gmail.com> (added bindings packaging)
# Contributor: Ivan Kanakarakis <ivan.kanak@gmail.com> (fixed bison failures and added conflicts array)
pkgname=zorba
pkgver=2.9.1
pkgrel=2
pkgdesc="General purpose embeddable XQuery processor written in C++."
url="http://www.zorba-xquery.com/"
arch=('i686' 'x86_64')
license=('APACHE')
depends=('libxml2>=2.7.0'
         'libxslt>=1.1.24'
         'icu>=3.6'
         'boost>=1.47'
         'xerces-c>=3.0.0'
)
optdepends=('curl>=7.21.0: REST and HTTP support'
            'python2: python 2 bindings'
            'java-runtime: java bindings'
            'ruby: ruby bindings'
)
makedepends=('cmake>=2.6.4'
             'flex>=2.5.33'
             'bison>=2.4'
             'gcc>=4.7'
             'swig>=1.3.40'
             'python2'
             'java-environment'
             'ruby'
)
source=(http://launchpad.net/${pkgname}/trunk/2.9/+download/${pkgname}-${pkgver}.tar.gz
        item_handle.patch
        bindings_dirs.patch
        parser_bison_3_0_compatibility.patch
)
md5sums=('680489ccfd4e1af083d10ca0aa63a6ba'
         '1c1f05f3919bcc78337976f4c68c21f9'
         'df5c9930f77a10a7cb284a3041f730be'
         'a2fcd5a592693f4fbc6c7e0e4a056e37')
conflicts=('xqilla')

prepare() {
  cd "$srcdir/${pkgname}-${pkgver}"
  patch -p0 -i ../item_handle.patch
  patch -p1 -i ../bindings_dirs.patch
  patch -p1 -i ../parser_bison_3_0_compatibility.patch
}

build() {
  mkdir "$srcdir/${pkgname}-${pkgver}/build" || true
  cd "$srcdir/${pkgname}-${pkgver}/build"

  python_ver="$(python2 -c 'import sys; print(sys.version[:3])')"
  ruby_ver="$(ruby -e 'puts RUBY_VERSION')"

  msg2 "Configuring..."
  cmake -Wno-dev \
        -DCMAKE_CXX_FLAGS="${CXXFLAGS} -std=gnu++11 -Wno-c++0x-compat"     \
        -DCMAKE_BUILD_TYPE=Release                                         \
        -DCMAKE_INSTALL_PREFIX=/usr                                        \
        -DPYTHON_INSTALL_PATH="/lib/python$python_ver/site-packages"       \
        -DRUBY_INSTALL_PATH="/lib/ruby/vendor_ruby/$ruby_ver/$CARCH-linux" \
        "$srcdir/${pkgname}-${pkgver}"

  msg2 "Compiling..."
  make
}

package() {
  cd "$srcdir/${pkgname}-${pkgver}/build"
  make DESTDIR="$pkgdir" install

  # compile python bindings
  python_ver="$(python2 -c 'import sys; print(sys.version[:3])')"
  python2 -m compileall "$pkgdir/usr/lib/python$python_ver"
  python2 -Om compileall "$pkgdir/usr/lib/python$python_ver"
}

