# Maintainer: Thomas Dziedzic < gostrc at gmail >
# Maintainer: Matthias matthiaskrgr Krüger < matthias · krueger _strange_curverd_character_ famsik · de >

pkgname=cppcheck-git
pkgver=1.61.241.g3f1e074
pkgver() {
    cd cppcheck
    git describe --tags | sed -e 's/^cppcheck\-//' -e 's/-/./g'
}
pkgrel=1
pkgdesc='A tool for static C/C++ code analysis'
arch=('i686' 'x86_64')
url='http://cppcheck.wiki.sourceforge.net'
license=('GPL3')
provides=('cppcheck')
conflicts=('cppcheck')
makedepends=('git') 
depends=('gcc-libs' 'pcre')
optdeps=('qt4: to build and run cppcheck-gui'
		 'python: to run cppcheck-htmlreport')
 source=('cppcheck::git://github.com/danmar/cppcheck.git')
sha1sums=('SKIP')


build() {
    cd "$srcdir"/cppcheck

    export CFLAGS="-march=native -mtune=native -O2"
    export CXXFLAGS="-march=native -mtune=native -O2"

    make
    if [[ -z `pacman -T qt4` ]] ; then

    export QMAKE_CFLAGS="-march=native -mtune=native -O2"
    export QMAKE_CXXFLAGS="-march=native -mtune=native -O2"

		msg 'qt4 found!'
		msg 'Building cppcheck-gui'
		cd "$srcdir"/cppcheck/gui
		qmake-qt4
		make
	fi
}

check() {

    export CFLAGS="-march=native -mtune=native -O2"
    export CXXFLAGS="-march=native -mtune=native -O2"


    cd "$srcdir"/cppcheck
    make test
}

package() {
    cd "$srcdir"/cppcheck
    make DESTDIR=${pkgdir} install

    export CFLAGS="-march=native -mtune=native -O2"
    export CXXFLAGS="-march=native -mtune=native -O2"

	make DESTDIR=${pkgdir} install
    if [[ -z `pacman -T qt4` ]] ; then
		cd "$srcdir"/cppcheck/gui
		install -Dm 755 ./cppcheck-gui ${pkgdir}/usr/bin/cppcheck-gui
		# make DESTDIR=${pkgdir} install # not supported :(
		cd ../
	fi
	cd ../
	mkdir -p ${pkgdir}/usr/share/cppcheck-htmlreport/
	install -Dm 755 cppcheck/htmlreport/* ${pkgdir}/usr/share/cppcheck-htmlreport/
	echo "#/bin/sh" > cppcheck-htmlreport # create script to run htmlreport from its dir
	echo "" >> cppcheck-htmlreport
	echo "/usr/share/cppcheck-htmlreport/cppcheck-htmlreport \$@" >> cppcheck-htmlreport
	install -Dm 755 ./cppcheck-htmlreport ${pkgdir}/usr/bin/cppcheck-htmlreport
}
