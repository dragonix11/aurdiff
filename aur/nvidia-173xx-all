# Maintainer : Maximilien Noal <noal dot maximilien at gmail dot com> [AUR: xcomcmdr]
# linux-3.10 patch from : Natrio <natrio at list dot ru> (nvidia-173xx)
# Contributor: 458italia <svenskaparadox at gmail dot com>
# Contributor: Amaury Couste <amaury dot couste at gmail dot com> 
# Based on nvidia-beta-all by Ng Oon-Ee <n g o o n e e AT g mail dot com>
# ...Which is based on nvidia-beta by Dan Vratil <vratil at progdansoft dot com>

pkgname=nvidia-173xx-all
pkgver=173.14.37
pkgrel=9
pkgdesc='NVIDIA drivers, 173xx branch, for all kernels.'
arch=('i686' 'x86_64')
provides='nvidia-96xx'
url='http://www.nvidia.com/'
depends="nvidia-173xx-utils>=${pkgver}"
makedepends='linux-headers'
optdepends=('pangox-compat: to run nvidia-settings')
conflicts=('nvidia' 'nvidia-304xx' 'nvidia-304xx-lts' 'nvidia-lts' \
  'nvidia-ck' 'nvidia-173xx' 'nvidia-173xx-lts' 'nvidia-275xx' \
  'nvidia-275xx-ck' 'nvidia-275xx-pf' 'nvidia-304xx-ck' 'nvidia-304xx-dkms' \
  'nvidia-304xx-pf' 'nvidia-96xx' 'nvidia-96xx-ck' 'nvidia-96xx-lts' \
  'nvidia-all' 'nvidia-beta' 'nvidia-beta-ck' 'nvidia-beta-dkms' \
  'nvidia-beta-zen' 'nvidia-bfs' 'nvidia-custom' 'nvidia-dkms' \
  'nvidia-f2fs' 'nvidia-fbcondor' 'nvidia-gl43preview' 'nvidia-linux-git' \
  'nvidia-ll' 'nvidia-lqx' 'nvidia-lqx-legacy' 'nvidia-lts-ck' \
  'nvidia-mainline' 'nvidia-pae' 'nvidia-pf' 'nvidia-uksm' 'nvidia-uksm-ck' \
  'nvidia-zen')
license='custom'
install='nvidia.install'
if [[ "$CARCH" = "i686" ]]; then
  _arch='x86'
  _nv='0'
  source=('http://download.nvidia.com/XFree86/Linux-x86/173.14.37/NVIDIA-Linux-x86-173.14.37-pkg0.run' \
    'linux-3.10.patch' 'linux-3.11.patch') 
fi
if [[ "$CARCH" = "x86_64" ]]; then
  _arch='x86_64'
  _nv='2'
  source=('http://download.nvidia.com/XFree86/Linux-x86_64/173.14.37/NVIDIA-Linux-x86_64-173.14.37-pkg2.run' \
    'linux-3.10.patch' 'linux-3.11.patch')
fi
options=(!strip)
md5sums=('ca80332b4e27d21108ceab9314420b9b' \
  'c104147d9541a43d74729c181c0a1899' \
  'a306b9bf0adf8212efa36615c365a6e5')
[ "$CARCH" = "x86_64" ] && md5sums[0]='ed3edf1d796129edb79703dbf3706854'

_packages=$(pacman -Qs linux | grep local/linux | awk {'print $1'})
_kernvers=$(pacman -Ql ${_packages} | grep /modules.alias.bin | \
  sed 's/.*\/lib\/modules\/\(.*\)\/modules.alias.bin/\1/g')

build() {
  msg "Building ${pkgname}..."
  for _kernver in ${_kernvers}
  do
    msg "Making module for linux ${_kernver} :"
    msg '1 of 4 - Extracting nvidia drivers...'
    cd ${srcdir}
    sh NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}.run --extract-only
    cd NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}/usr/src/nv
    _curkver=$(echo ${_kernver}|cut -d\- -f1|tr -d '.'| tr -d '[A-Z][a-z]')
    _curkver=$(echo ${_curkver}|cut -c 1-3)
    if [[ ${_curkver} -ge 310 ]]; then
      msg "2 of 4 - Applying patches: linux-3.10.patch..."
      patch -p1 -i ${srcdir}/linux-3.10.patch
    fi
    if [[ ${_curkver} -ge 311 ]]; then
      msg "2 of 4 - Applying patches: linux-3.11.patch..."
      patch -p0 -i ${srcdir}/linux-3.11.patch
    fi
    msg "3 of 4 - Building module for ${_kernver}..."
    make SYSSRC=/lib/modules/${_kernver}/build module
    msg '4 of 4 - Making preparations for next kernel/packaging...'
    mv nvidia.ko ${srcdir}/nvidia-${_kernver}.ko
    mv -f ${srcdir}/NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}/LICENSE \
      ${srcdir}/LICENSE
    rm -rf ${srcdir}/NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}
  done
}

package() {
  msg "Packaging ${pkgname}..."
  for _kernver in ${_kernvers}
  do
    mkdir -p ${pkgdir}/lib/modules/${_kernver}/kernel/drivers/video
    install -m644 ${srcdir}/nvidia-${_kernver}.ko \
      ${pkgdir}/lib/modules/${_kernver}/kernel/drivers/video/nvidia.ko
    gzip ${pkgdir}/lib/modules/${_kernver}/kernel/drivers/video/nvidia.ko
    mkdir -p ${pkgdir}/usr/share/licenses/${pkgname}
    install -m644 ${srcdir}/LICENSE ${pkgdir}/usr/share/licenses/${pkgname}
  done
  if [ ! -f /etc/modprobe.d/nouveau_blacklist.conf ]; then
    mkdir -p ${pkgdir}/etc/modprobe.d
    echo "blacklist nouveau" >> \
      ${pkgdir}/etc/modprobe.d/nouveau_blacklist.conf
  fi
}
