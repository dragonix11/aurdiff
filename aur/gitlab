# Contributor: Jonas Heinrich <onny@project-insanity.org>
# Contributor: Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
# Maintainer: Jonas Heinrich <onny@project-insanity.org>

#  lib/support/nginx/gitlab
# gitlab-shell missing
# datadir=/var/lib/gitlab                                                                             
# homedir=/usr/lib/gitlab
    

pkgname=gitlab
pkgver=6.1.0
pkgrel=5
pkgdesc="Project management and code hosting application"
arch=('any')
url="https://www.gitlab.org"
license=('MIT')
depends=('ruby' 'ruby-bundler' 'python2' 'gitlab-shell' 'postgresql-libs')
makedepends=('sudo')
# base-devel zlib libyaml openssl gdbm readline ncurses libffi curl openssh redis libxml2 libxslt icu 
optdepends=(
    'mariadb: database backend'
    'postgresql: database backend'
    'python2-docutils: reStructuredText markup language support'
    'postifx: mail server in order to receive mail notifications'
)
backup=(etc/gitlab/gitlab.yml etc/gitlab/resque.yml etc/gitlab/database.yml)
source=("$pkgname-$pkgver.tar.gz::https://github.com/gitlabhq/gitlabhq/archive/v${pkgver}.tar.gz"
        "gitlab.service"
        "gitlab-sidekiq.service")
install='gitlab.install'
sha512sums=("0ae85d461db068e8200a285b11ed6698b3b23464ee5fcbdbde1289b615968ce13fb3a740efbef784e6779672c44adadc572c74285b77257ad19798ab0f6f4ed1"
            "f515a6a6b94b5c15405978addd2923dbfa4aaedd9eff2aa2760f53c3a88ec8148fb39b6bcb5897d5b0e586e44945475b1c3cd09350138d0ae7560aae504120dd"
            "64b81772fda07c842a0eff58ac533cca0b6f2122f7746dccb93d24f1e0ca7a1871605d0dad91ad46e5a1b6c226844c3584160f8b2504711115f84c290a5412c6")
options=('!strip')

build() {
        cd "$srcdir/gitlabhq-$pkgver"

        #gem install charlock_holmes --version '0.6.9.4'

        msg "Fetching bundled gems..."
        bundle install --deployment --without development test aws
        # bundle install --deployment --binstubs --no-cache --without test
        # bundle install --no-deployment --binstubs --path=vendor/bundle --no-cache --without test
}

package() {
    local datadir=/usr/share/webapps/gitlab
    local homedir=/home/gitlab
    local wwwdir=$homedir/www

    cd $srcdir/gitlabhq-$pkgver

    # Creating directories
    install -d \
        "$pkgdir/etc/gitlab" \
        "$pkgdir/usr/share/webapps" \
        "$pkgdir/usr/share/doc/$pkgname" \
        "$pkgdir/usr/share/licenses/$pkgname" \
        "$pkgdir/usr/lib/gitlab/pids" \
        "$pkgdir/usr/lib/gitlab/www" \
        "$pkgdir/usr/share/webapps/$pkgname/www" \
        "$pkgdir/usr/share/webapps/$pkgname/tmp" \
        "$pkgdir/usr/share/webapps/$pkgname/log"
    touch $pkgdir/usr/lib/gitlab/.secret
    touch $pkgdir/usr/share/webapps/gitlab/.secret
    
    # Install config files
    sed -e 's|# user: git|user: gitlab|' \
        -e "s|/home/git/repositories|$datadir/repositories|" \
        -e "s|/home/git/gitlab-satellites|$datadir/satellites|" \
        -e "s|/home/git|$homedir|" \
        config/gitlab.yml.example > "$pkgdir/etc/gitlab/gitlab.yml"
    [ -f config/gitlab.yml ] || ln -s /etc/gitlab/gitlab.yml config/gitlab.yml
    cp config/database.yml.mysql $pkgdir/etc/gitlab/database.yml
    [ -f config/database.yml ] || ln -s /etc/gitlab/database.yml config/database.yml

    # Install license, help and systemd service files
    mv LICENSE "$pkgdir/usr/share/licenses/$pkgname"
    mv README.md MAINTENANCE.md CONTRIBUTING.md CHANGELOG config/*.{example,mysql,postgresql} "$pkgdir/usr/share/doc/$pkgname"
    install -Dm0755 "$srcdir/gitlab.service" "$pkgdir/usr/lib/systemd/system/gitlab.service"
    install -Dm0755 "$srcdir/gitlab-sidekiq.service" "$pkgdir/usr/lib/systemd/system/gitlab-sidekiq.service"

	cp -r $srcdir/gitlabhq-$pkgver/* "$pkgdir/usr/share/webapps/$pkgname/"
}

# vim:set ts=4 sw=4 et:
