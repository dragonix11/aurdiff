# Maintainer: almostalive <almostalive2003 at gmail dot com>

pkgname=libretro-bsnes-git
_gitname=bsnes
pkgver=367.fe8bd6b
pkgrel=1
pkgdesc="libretro implementation of bSNES. (Super Nintendo Entertainment System)"
arch=('i686' 'x86_64' 'arm' 'armv6h')
url="http://gitorious.org/bsnes"
license=('GPL3')
makedepends=('git')
source=("${_gitname}::git://gitorious.org/bsnes/${_gitname}.git#branch=libretro")
md5sums=('SKIP')

pkgver() {
  cd "${_gitname}"
  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

build() {
  cd "${_gitname}"
  git clone . perf
  git clone . balanced
   
if [ -z "${CC}" ]; then
CC=gcc
fi

echo "=== Building bSNES performance ==="
  cd "perf/higan"
  make compiler="${CC}" ui=target-libretro profile=performance || die "Failed to build bSNES performance core"
  cp -f "out/bsnes_libretro.so" "${srcdir}/${_gitname}/libretro-bsnes-performance.so"
  cd "${srcdir}/${_gitname}"

echo "=== Building bSNES balanced ==="
  cd "balanced/higan"
  make compiler="${CC}" ui=target-libretro profile=balanced || die "Failed to build bSNES compatibility core"
  cp -f "out/bsnes_libretro.so" "${srcdir}/${_gitname}/libretro-bsnes-balanced.so"
  cd "${srcdir}/${_gitname}"

echo "=== Building bSNES accuracy ==="
  cd "higan"
  make compiler="${CC}" ui=target-libretro profile=accuracy || die "Failed to build bSNES accuracy core"
  cp -f "out/bsnes_libretro.so" "${srcdir}/${_gitname}/libretro-bsnes-accuracy.so"
  cd "${srcdir}/${_gitname}"
}

package() {
  install -Dm644 "${_gitname}/libretro-bsnes-performance.so" "${pkgdir}/usr/lib/libretro/libretro-bsnes-performance.so"
  install -Dm644 "${_gitname}/libretro-bsnes-balanced.so" "${pkgdir}/usr/lib/libretro/libretro-bsnes-balanced.so"
  install -Dm644 "${_gitname}/libretro-bsnes-accuracy.so" "${pkgdir}/usr/lib/libretro/libretro-bsnes-accuracy.so"
}