# Maintainer: 3ED_0 <krzysztof1987 at gmail>
# Contributor: Bjoern Franke <bjo@nord-west.org>

pkgname=nvidia-96xx-lts
pkgver=96.43.23
pkgrel=4
_kver_ge="3.0.36"
_kver_lt="3.1"
pkgdesc="NVIDIA drivers for linux-lts, 96xx branch."
url="http://www.nvidia.com/"
arch=('i686' 'x86_64')
depends=("linux-lts>=${_kver_ge}"
         "linux-lts<${_kver_lt}"
         "nvidia-96xx-utils")
makedepends=("linux-lts-headers>=${_kver_ge}"
             "linux-lts-headers<${_kver_lt}")
provides=('nvidia-96xx')
conflicts=('nvidia'
           'nvidia-all'
           'nvidia-96xx-all'
           'nvidia-173xx'
           'nvidia-275xx'
           'nvidia-304xx'
           'nvidia-beta-all'
           'nvidia-beta')
license=('custom')
install=nvidia.install
options=(!strip)

[ "$CARCH" = "i686"   ] && _arch=x86 && _nv=0
[ "$CARCH" = "x86_64" ] && _arch=x86_64 && _nv=2
source=("http://download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}.run")

md5sums=('ca0bc6ae3b37cb259f3a906b4dc4670b')
[ "$CARCH" = "x86_64" ] && md5sums[0]='dd8546e5ae7d10da072306e5f13952b8'

_extramodules=$(echo /usr/lib/modules/extramodules-[0-9.]*-lts/version|cut -d/ -f5)
_kernver="$(cat /usr/lib/modules/${_extramodules}/version)"

prepare() {
  test ! -d NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv} \
    || rm -rf NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}
   
  sh NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}.run --extract-only

  ln -sf Makefile.kbuild "$srcdir/NVIDIA-Linux-${_arch}-${pkgver}-pkg0/usr/src/nv/Makefile"
}

build() {
  cd NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}/usr/src/nv
  make SYSSRC=/usr/lib/modules/${_kernver}/build module
}

package() {
  cd NVIDIA-Linux-${_arch}-${pkgver}-pkg${_nv}
  install -dm755 "$pkgdir/usr/share/licenses/${pkgname}/"
  install  -m644 LICENSE "$pkgdir/usr/share/licenses/${pkgname}/"

  cd usr/src/nv
  install -dm755 "$pkgdir/usr/lib/modules/${_extramodules}/"
  install  -m644 nvidia.ko "$pkgdir/usr/lib/modules/${_extramodules}/"
  gzip "${pkgdir}/usr/lib/modules/${_extramodules}/nvidia.ko"

  install -dm755 "$pkgdir/etc/modprobe.d"

  sed -i -e "s/EXTRAMODULES='.*'/EXTRAMODULES='${_extramodules}'/" "$startdir/nvidia.install"
}
