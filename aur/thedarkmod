# Maintainer: naelstrof <naelstrof@gmail.com>
pkgname=thedarkmod
pkgver=2.0
pkgrel=3
pkgdesc="THE DARK MOD is a dark and moody stealth game inspired by the Thief series by Looking Glass Studios. You need the game data to play."
arch=( 'any' )
url="http://www.thedarkmod.com"
license=( 'custom' )
depends=( 'lib32-alsa-lib'
          'lib32-libgl'
          'lib32-libstdc++5'
          'lib32-libpng12'
          'lib32-libxxf86vm'
          'lib32-openal' )
makedepends=( 'imagemagick' 'coreutils' ) # for convert and md5sum
# Unfortunately how Looking Glass Studios distributes their game we'll have to do file validation mid-script.
source=( )
md5sums=( )

# These files are not critical, so they're not copied or summed
    #'TheDarkMod.exe'
    #'description.txt'
    #'tdm_update.exe'
    #'tdm_update.log'
    #'tdm_version_info.txt'
    #'tdm_mirrors.txt'
    #'tdm_mirrors.txt~'
    #'tdm_mirrors_2.txt'
    #'tdm_mirrors_backup.txt'
    #'crc_info.txt'
_files=( 'AUTHORS.txt'
         'LICENSE.txt'
         'TDM_icon.ico'
         'darkmod.ico'
         'darkmod.ini'
         'tdm_ai_animals01.pk4'
         'tdm_ai_base01.pk4'
         'tdm_ai_humanoid_builders01.pk4'
         'tdm_ai_humanoid_females01.pk4'
         'tdm_ai_humanoid_guards01.pk4'
         'tdm_ai_humanoid_heads01.pk4'
         'tdm_ai_humanoid_mages01.pk4'
         'tdm_ai_humanoid_nobles01.pk4'
         'tdm_ai_humanoid_pagans01.pk4'
         'tdm_ai_humanoid_townsfolk01.pk4'
         'tdm_ai_humanoid_undead01.pk4'
         'tdm_ai_monsters_spiders01.pk4'
         'tdm_ai_steambots01.pk4'
         'tdm_base01.pk4'
         'tdm_defs01.pk4'
         'tdm_env01.pk4'
         'tdm_fonts01.pk4'
         'tdm_game01.pk4'
         'tdm_game02.pk4'
         'tdm_gui01.pk4'
         'tdm_gui_credits01.pk4'
         'tdm_models01.pk4'
         'tdm_models02.pk4'
         'tdm_models_decls01.pk4'
         'tdm_player01.pk4'
         'tdm_prefabs01.pk4'
         'tdm_sound_ambient01.pk4'
         'tdm_sound_ambient02.pk4'
         'tdm_sound_ambient03.pk4'
         'tdm_sound_ambient_decls01.pk4'
         'tdm_sound_sfx01.pk4'
         'tdm_sound_sfx02.pk4'
         'tdm_sound_vocals01.pk4'
         'tdm_sound_vocals02.pk4'
         'tdm_sound_vocals03.pk4'
         'tdm_sound_vocals04.pk4'
         'tdm_sound_vocals05.pk4'
         'tdm_sound_vocals06.pk4'
         'tdm_sound_vocals07.pk4'
         'tdm_sound_vocals_decls01.pk4'
         'tdm_standalone.pk4'
         'tdm_textures_base01.pk4'
         'tdm_textures_carpet01.pk4'
         'tdm_textures_decals01.pk4'
         'tdm_textures_door01.pk4'
         'tdm_textures_fabric01.pk4'
         'tdm_textures_glass01.pk4'
         'tdm_textures_metal01.pk4'
         'tdm_textures_nature01.pk4'
         'tdm_textures_paint_paper01.pk4'
         'tdm_textures_plaster01.pk4'
         'tdm_textures_roof01.pk4'
         'tdm_textures_sfx01.pk4'
         'tdm_textures_stone_brick01.pk4'
         'tdm_textures_stone_cobblestones01.pk4'
         'tdm_textures_stone_flat01.pk4'
         'tdm_textures_stone_natural01.pk4'
         'tdm_textures_stone_sculpted01.pk4'
         'tdm_textures_window01.pk4'
         'tdm_textures_wood01.pk4'
         'tdm_update.linux'
         'thedarkmod.x86'
         'fms/saintlucia/saintlucia.pk4'
         'fms/training_mission/training_mission.pk4' )
_sums=( '3144321e5d2ac72dc4288929f1cdd6fa'
        '21726e729150ab4e6ad090fddb9a1f1a'
        'eb7ce3b948bcd64e6b96c96862188e43'
        '11006c472f38d6c17c82e24e3e56f8a1'
        '774ced5c695ab998b87134822a015c42'
        'c6ae8be6c2f47ffede2b971a9bef8dba'
        '63e75c2c7a9444becc5ae73a508bde81'
        'db3979ed4749746d694ae41044f4d0d9'
        '011f8319aae33302c96feb5eab6e4c47'
        'fc46bd0e520049af8eeec348bc8a198a'
        'b01af3bfc8728e8ab887600d904a50d9'
        '9f9ff4901440807f7ac9c93567565373'
        '51b427d941f1090146320c9d3d75c350'
        '550d8f08f9178511e489191e7eab4897'
        '7611ba1152873228d60d759691bdcecc'
        'f848ed025aae3975d39930b7b67ce020'
        '5952ef0442de2913738d0eb2c26c4530'
        '109edff5a1f191278b8ab505480daf6b'
        '5ddf986789fac2cfe997796cda5c8210'
        '8416d48de880d2f8118a097c36b21d64'
        '39ff7314e42f592aa801ae8e4d54afa8'
        '8018f4c4962ee2f8006aac17947a634a'
        '3f125a6d7cdc5192396234fb27d8eb80'
        '1b20f25e24c3c7e5d650a6f83dbde76a'
        '6709898330c122df7e10117a51f0087a'
        'c599c1b6b6a54673be45ebd9e1736aec'
        '600c72ff4a7e2f25a97ddf9deaec72ad'
        'c8dc1ff0161ac5a683caec64b52f7522'
        '04eeb6a4f8d9e13959aee4409d70078b'
        'da66f9cb73c15af6493f060e7091f722'
        '43f4c120872282fccb192f3f4334df15'
        '37c77bf2efb77518a1a02d74515c53d3'
        'a5853a4932b4ba8e9132a415c734ec56'
        '66eee18144c6b8965902646d6edfffdc'
        'ba6161d98f4f278d70798142c5c57ba3'
        'a43e95484954b87dafd7d1802a2b94fe'
        '198fc2c0609bebc8a0ef5c9834445af1'
        '7076e17b4e458e402eb87d99187ba41a'
        'f5f3154a53075a1858bbf4cc8e3845b7'
        'dcbcc02d7326538c0c7c4f4eaa019a78'
        '64224fb6098c96254b42ac95cfdb6cb7'
        '2fcd4311738bc6591cf713d8a63b1b43'
        'e12769f5d085ca3061129471c2a1b653'
        'c47e470b5851fc040c4b61ee073f5fe0'
        '7c760c13a3a621ee3d83e637dfa490d7'
        '080e0b42e115139a278e9615c5a88961'
        '834eed9a5b96d60e28735430c4beaab1'
        '7cd01f679edfabed8017e8a73b06620b'
        '92ceef471469d0d49114fe579df3649e'
        '33c804ed57ef094ad960510a44126bff'
        '7460f2ff8cad1f6bcff12c7d96559d6f'
        '62e833f497a8703018cfd8bbcf7c8bc3'
        '56a0d898752200de2497cd32345f906c'
        '4dbf97d489cf5eddcbf5385afe98fd25'
        'e94c722c28e509d258a865cc2748ea41'
        '4edb8da77c42e17635b4a64478f6860c'
        'ea48d08f9c0c918a790ce65f993ab7e1'
        '8f60b0f7465db9ef33ac52f7076158d4'
        '79d23f404e46e262ec6d8595e84d056a'
        'c751a9c623f42374c0242ecf447db3da'
        '311a6539fba202e13f5ba6b6725abbf1'
        '41837a7d00df8b66b3629d1cd888f1ea'
        '5b62d0df52b33909588ecd7341ce529f'
        '017b52bb0574403dc06d861a0b7ee584'
        '9d9c2fc7063bdca55a88902d883e5bd9'
        'f88d1688c995abed767d551b4618eb60'
        'fe15750174ae929061ffce4315fc07b3'
        '29e46ce8f860052ddebeee53e30b0694'
        'c2f93790e2bef50b3049118bbccc87b4' )

_installdir="/usr/share/games/${pkgname}"

package() {
    msg "This package requires the THE DARK MOD Version 2.0 - Standalone Release game files."
    msg "You can aquire them for free from thedarkmod's website."
    msg "Please enter directory containing thedarkmod.x86:"
    read _dir

    # Validation-----------------------------------------
    # Make sure the inputted directory is sane
    if [ ! -f "${_dir}/thedarkmod.x86" ]; then
        error "${_dir}/thedarkmod.x86 not found!"
        exit 1
    fi
    msg "Validating files..."
    # Then attempt to manually verify all sums.
    for i in "${!_files[@]}"; do
        _file="${_files[$i]}"
        # Get the plain md5sum of the file
        _checksum=`md5sum "${_dir}/${_file}" | cut -f 1 -d " "`
        # Grab the required md5sum from our _sums array
        _realsum="${_sums[$i]}"
        if [ "${_checksum}" != "${_realsum}" ]; then
            error "${_file} failed checksum validation!"
            error "Real:     ${_realsum}"
            error "Required: ${_checksum}"
            exit 1
        fi
    done
    # We're verified!
    # ----------------------------------------------------

    msg "Generating periphery files..."
    # .desktop generation---------------------------------
    mkdir -p "${pkgdir}/usr/share/applications"
    mkdir -p "${pkgdir}/usr/share/pixmaps"
    mkdir -p "${pkgdir}/usr/share/licenses/${pkgname}"
    mkdir -p "${pkgdir}/usr/bin"
    _f="${pkgdir}/usr/share/applications/${pkgname}.desktop"
    echo "[Desktop Entry]"               >  $_f
    echo "Name=The Dark Mod"             >> $_f
    echo "Comment=${pkgdesc}"            >> $_f
    echo "Exec=${pkgname}"               >> $_f
    echo "Icon=${pkgname}.png"           >> $_f
    echo "Type=Application"              >> $_f
    echo "Categories=Game;ActionGame;"   >> $_f

    _f="${pkgdir}/usr/bin/${pkgname}"
    echo "#!/bin/bash"                   >  $_f
    echo "cd ${_installdir}"             >> $_f
    echo "sg games -c ./thedarkmod.x86"  >> $_f

    # FIXME: Not sure if pixmaps can be ico's or not--
    mkdir -p "${pkgdir}/usr/share/pixmaps/tmp/"
    convert "${_dir}/darkmod.ico" "${pkgdir}/usr/share/pixmaps/tmp/${pkgname}.png"
    mv "${pkgdir}/usr/share/pixmaps/tmp/${pkgname}-10.png" "${pkgdir}/usr/share/pixmaps/${pkgname}.png"
    rm -R "${pkgdir}/usr/share/pixmaps/tmp/"

    cp "${_dir}/LICENSE.txt" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
    # ----------------------------------------------------

    msg "Copying files..."
    # Assume the files are validated
    # file copying----------------------------------------
    for i in "${_files[@]}"; do
        # Make sure our path exists before attempting to copy
        _dirname=`dirname "$i"`
        mkdir -p "${pkgdir}${_installdir}/${_dirname}"
        cp "${_dir}/$i" "${pkgdir}${_installdir}/$i"
    done
    # ----------------------------------------------------

    msg "Setting permissions..."
    # Make sure any user capable of gaming can create config files
    chown root:games ${pkgdir}${_installdir}
    chmod g+w ${pkgdir}${_installdir}
    # Make sure any user capable of gaming can download maps
    chown -R root:games ${pkgdir}${_installdir}/fms
    chmod -R g+w ${pkgdir}${_installdir}/fms
    # Make sure any user can execute the game
    chmod +x ${pkgdir}${_installdir}/thedarkmod.x86
    chmod +x ${pkgdir}/usr/bin/thedarkmod

    # We're done! Enjoy the game--
}
