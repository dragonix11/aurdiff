# -*- shell-script -*-
#
# Contributor: Adrian C. <anrxc..sysphere.org>

basename=vlc
pkgname=vlc-mini
pkgver=2.0.8.a
pkgrel=3
pkgdesc="A MPEG, VCD, DVD and DivX player with minimal dependencies"
arch=("i686" "x86_64")
url="http://www.videolan.org/vlc/"
license=("GPL2")
depends=("ffmpeg-compat" "libmad" "qt4" "libdvdread" "libxml2" "libraw1394"
         "a52dec" "x264" "libmpeg2" "v4l-utils" "libavc1394" "live-media"
         "libxcb" "flac" "faad2" "lua51")
makedepends=("pkgconfig" "live-media" "lirc-utils" "ncurses")
optdepends=("libdvdcss: for decoding encrypted DVDs"
            "lirc-utils: for lirc plugin"
            "ncurses: for ncurses interface support")
provides=("vlc")
conflicts=("vlc")
backup=("usr/share/vlc/lua/http/.hosts"
        "usr/share/vlc/lua/http/dialogs/.hosts")
options=("!libtool" "!emptydirs")
install="${pkgname}.install"
source=("http://download.videolan.org/pub/videolan/${basename}/${pkgver/.a}/${basename}-${pkgver/.a/a}.tar.xz"
        "vlc-2.0.7-vaapi-compat.patch"
        "vlc-2.0.8-Fix-live555-breakage-in-last-update.patch")
sha256sums=("05215f34c487723c84ebb54ab43b836fc70fb466326f7c601847141a499034d2"
            "8bfecda9a95d514b3ceb225a172e82f1258bd1653bc60045b40fc5e68f6ccef3"
            "5d34628ba57fea33302417e4f363c049e71d0b9eec4ad544b4da78008fbeae6e")


build() {
  #cd "${srcdir}/${basename}-${pkgver}"
  cd "${srcdir}/${basename}-${pkgver/.a}"

# Apply patches
  patch -Np1 -i ../vlc-2.0.7-vaapi-compat.patch
  patch -Np1 -i ../vlc-2.0.8-Fix-live555-breakage-in-last-update.patch
  sed -i -e 's:truetype/freefont:TTF:g' modules/text_renderer/freetype.c
  sed -i -e 's:truetype/ttf-dejavu:TTF:g' modules/visualization/projectm.cpp

# Architecture specific build flags
  if [ "${CARCH}" = "x86_64" ]; then
    ARCHOPTS="--disable-loader"
  else
    ARCHOPTS="--enable-loader"
  fi

# Source code build
  PKG_CONFIG_PATH+="/usr/lib/ffmpeg-compat/pkgconfig/" \
  ./configure --prefix=/usr \
              LUAC=luac5.1 RCC=/usr/bin/rcc-qt4 $ARCHOPTS \
              --enable-lua --enable-httpd --enable-alsa \
              --enable-vlc --enable-vlm --enable-sout \
              --enable-optimize-memory --enable-optimizations \
              --enable-qt4 --enable-dv --enable-dvdread --enable-vcd \
              --enable-mad --enable-a52 --enable-flac --enable-realrtsp --enable-live555 \
              --enable-vorbis --enable-ogg --enable-theora \
              --enable-xvideo --enable-xcb --enable-freetype \
              --enable-libass --enable-fontconfig --enable-libxml2 --enable-screen \
              --enable-libmpeg2 --enable-faad --enable-v4l2 \
              --enable-avcodec --enable-avformat --enable-x264 \
              --enable-lirc --enable-ncurses \
              --disable-udev --disable-dbus --disable-nls --disable-rpath --disable-mtp \
              --disable-dbus-control --disable-telepathy --disable-debug \
              --disable-gprof --disable-cprof --disable-run-as-root \
              --disable-coverage --disable-switcher --disable-shout \
              --disable-libproxy --disable-dvdnav --disable-oss \
              --disable-libcddb --disable-growl --disable-notify \
              --disable-taglib --disable-dc1394 --disable-pvr --disable-gnomevfs \
              --disable-dshow --disable-opencv --disable-smb \
              --disable-vcdx --disable-libtar --disable-dca \
              --disable-mkv --disable-mod --disable-mpc --disable-wma-fixed \
              --disable-gme --disable-swscale --disable-shine \
              --disable-postproc --disable-png --disable-fluidsynth \
              --disable-twolame --disable-quicktime --disable-real \
              --disable-dirac --disable-schroedinger \
              --disable-zvbi --disable-telx --disable-tiger --disable-kate \
              --disable-glx --disable-tremor --disable-speex \
              --disable-sdl-image --disable-sdl --disable-svg --disable-opus \
              --disable-directx --disable-directfb --disable-pulse \
              --disable-aa --disable-caca --disable-wingdi --disable-portaudio \
              --disable-waveout --disable-macosx-audio --disable-jack --disable-upnp \
              --disable-skins2 --disable-fbosd --disable-visual --disable-kva \
              --disable-macosx --disable-xosd --disable-goom --disable-atmo --disable-kai \
              --disable-bonjour --disable-libgcrypt --disable-gnutls --disable-update-check
  CFLAGS="-fPIC"
  make
}

package () {
  #cd "${srcdir}/${basename}-${pkgver}"
  cd "${srcdir}/${basename}-${pkgver/.a}"

# Install VLC
  make DESTDIR=${pkgdir}/ install

# Install icons
  for res in 16 32 48 128; do
    #install -D -m644 ${srcdir}/vlc-${pkgver}/share/icons/${res}x${res}/vlc.png \
    install -D -m644 ${srcdir}/vlc-${pkgver/.a}/share/icons/${res}x${res}/vlc.png \
        ${pkgdir}/usr/share/icons/hicolor/${res}x${res}/apps/vlc.png
  done
}
